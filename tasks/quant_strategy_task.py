# tasks/quant_strategy_task.py

from crewai import Task
from agents.quant_strategy_agent import quant_strategy_expert
from datetime import datetime

# 定义严格的 Markdown 输出模板（直接使用你提供的模板）
QUANT_STRATEGY_REPORT_TEMPLATE = """
### **{commodity_name} 结构化策略设计方案**
**设计时间**: {design_time}

#### **一、核心市场观点提炼**
[基于前面的分析报告，用1-2句话总结对{commodity_name}未来价格走势的核心判断，例如：“预计未来1-2个月内，{commodity_name}价格将在[区间]内震荡，有温和上涨预期。”]

#### **二、策略一：单边套期保值方案**

*   **适用场景**：[例如：下游企业担心未来{commodity_name}原料价格上涨，锁定采购成本。]
*   **策略结构**：
    *   **操作**：买入看涨期权 或 卖出看跌期权
    *   **标的**：{commodity_name}主力合约
    *   **期权类型**：[例如：看涨期权]
    *   **行权价 (K)**：[建议一个具体的行权价，例如：当前期货价 + 2%]
    *   **到期日**：[建议一个到期月份，例如：下个月交割的合约]
    *   **数量**：[例如：对应100吨现货的头寸]
    *   **权利金 (C)**：[估算一个权利金，例如：50元/吨]
*   **成本与损益分析**：
    *   **最大风险**：[例如：损失全部权利金，50元/吨]
    *   **最大收益**：[例如：无限（如果买入看涨）]
    *   **盈亏平衡点**：[例如：行权价 + 权利金]
*   **策略优势**：[例如：锁定最高采购价，同时保留价格下跌时的采购灵活性。]

#### **三、策略二：成本优化方案**

*   **适用场景**：[例如：持有现货库存，希望通过期权降低仓储资金成本或增厚收益。]
*   **策略结构**：
    *   **操作**：备兑开仓 或 卖出看涨期权
    *   **标的**：{commodity_name}主力合约
    *   **期权类型**：[例如：看涨期权]
    *   **行权价 (K)**：[建议一个具体的行权价，例如：当前期货价 + 5%]
    *   **到期日**：[建议一个到期月份]
    *   **数量**：[例如：与持有的现货数量相等]
    *   **权利金收入 (C)**：[估算一个权利金收入，例如：80元/吨]
*   **成本与损益分析**：
    *   **最大风险**：[例如：现货价格大幅上涨，收益被锁定在行权价]
    *   **最大收益**：[例如：权利金收入 + (行权价 - 现货成本)]
    *   **盈亏平衡点**：[例如：现货成本 - 权利金收入]
*   **策略优势**：[例如：直接获得权利金收入，有效降低持仓成本。]

#### **四、策略三：利润增厚方案**

*   **适用场景**：[例如：预期市场将温和上涨或盘整，希望在有限风险下获取额外收益。]
*   **策略结构**：
    *   **操作**：牛市价差 或 熊市价差
    *   **标的**：{commodity_name}主力合约
    *   **期权类型**：[例如：买入低行权价看涨期权 + 卖出高行权价看涨期权]
    *   **行权价组合 (K1, K2)**：[建议两个具体的行权价，例如：K1=当前价, K2=当前价+5%]
    *   **到期日**：[建议一个到期月份]
    *   **数量**：[例如：1:1配对]
    *   **净权利金**：[例如：净支出20元/吨]
*   **成本与损益分析**：
    *   **最大风险**：[例如：净权利金支出，20元/吨]
    *   **最大收益**：[例如：K2 - K1 - 净权利金支出]
    *   **盈亏平衡点**：[例如：K1 + 净权利金支出]
*   **策略优势**：[例如：风险和成本都有限，适合在温和看涨时增强收益。]

#### **五、综合风险提示**
*   **模型风险**：[例如：策略基于历史数据，市场极端情况下可能失效。]
*   **流动性风险**：[例如：远月或虚值期权可能流动性不足，影响开平仓。]
*   **执行风险**：[例如：交易滑点和手续费对策略收益的影响。]
*   **希腊字母风险**：[简要提及Vega、Theta等风险，例如：“需注意时间价值衰减和波动率变化对组合价值的影响。”]
"""

quant_strategy_task = Task(
    description=(
        "你将获得前面所有分析任务（宏观、供需、库存、基差、技术分析）的完整输出。"
        "请将这些输出视为一份完整的《{commodity_name}市场分析报告》。"
        "基于这份报告，你的任务是设计一套具体的、包含参数的、以期权为核心的结构化策略。"
        "请严格按照以下步骤执行："
        "1. **综合分析**：仔细阅读并理解前面所有报告的核心观点、关键数据（如价格区间、库存水平、基差位置）和最终的技术分析结论。"
        "2. **提炼观点**：在“核心市场观点提炼”部分，用1-2句话总结你对{commodity_name}未来价格走势的核心判断。"
        "3. **设计策略**：基于你的核心判断，设计三套策略：单边套期保值、成本优化、利润增厚。"
        "   - 确保所有策略的参数（行权价、到期日等）都与报告中的结论（如当前价格、波动预期）相符。"
        "   - 策略必须具体、可执行，并清晰地解释其适用场景、成本、收益和风险。"
        "4. **生成报告**：将你的设计和分析，严格地、一字不差地填充到给定的 Markdown 模板中。"
    ),
    expected_output=QUANT_STRATEGY_REPORT_TEMPLATE,
    agent=quant_strategy_expert,
    async_execution=False # 这是最终的决策任务，必须在所有分析完成后执行
)
