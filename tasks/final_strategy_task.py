# tasks/final_strategy_task.py

from crewai import Task
from agents.chief_strategy_agent import chief_strategy_agent

# 定义最终的输出模板
FINAL_STRATEGY_REPORT_TEMPLATE = """
# {commodity_name} 综合风险管理战略结论

## 总体市场评估
[一句话总结当前市场的核心特征和总体基调。]

## 关键发现与矛盾点
- **关键发现 1**: [列出最重要的发现，并说明其来源的报告。]
- **关键发现 2**: [列出次重要的发现。]
- **矛盾点分析**: [如果存在，请明确指出各报告间的矛盾信号，并给出你的解释。例如：“宏观报告显示流动性收紧（利空），但产业基本面报告显示供应出现重大缺口（利多），短期内多空因素交织，市场波动可能加剧。”]

## 主要风险排序
1.  **[首要风险]**: [例如：价格大幅下跌风险]
2.  **[次要风险]**: [例如：基差不利变动风险]
3.  **[潜在风险]**: [例如：供应链中断风险]

## 战略方向与机会
- **总体策略建议**: [明确给出总体策略，如“建议采取积极套保策略，锁定未来利润”或“建议保持谨慎观望，利用期权工具对冲尾部风险”。]
- **最值得关注的策略机会**:
    1.  [例如：基于当前高基差的期现套利机会。]
    2.  [例如：利用波动率放大的机会，构建跨式期权组合。]
"""

final_strategy_task = Task(
    description=(
        "你将作为首席商品策略师，审阅所有分析团队提交的报告。"
        "你的任务是整合这些信息，进行交叉验证，并形成最终的战略结论。"
        "请仔细阅读你收到的所有上下文信息（即前面所有任务的输出报告），"
        "并严格按照以下步骤进行分析和报告撰写："
        "1. **信息交叉验证**：检查各报告结论是否相互支撑，识别并分析任何矛盾信号。"
        "2. **核心风险排序**：根据综合分析，对企业面临的主要风险进行排序。"
        "3. **战略方向建议**：提出总体风险管理策略，并点出具体的策略机会。"
        "4. **生成报告**：将你的分析和结论，严格地填充到给定的 Markdown 模板中。"
    ),
    expected_output=FINAL_STRATEGY_REPORT_TEMPLATE,
    agent=chief_strategy_agent,
    # 这是关键！将此任务的上下文设置为所有前置的分析任务
    # CrewAI 会自动将这些任务的输出传递给此任务
    context=[ # context 列表将在 main.py 中填充
        # macro_economic_analysis_task,
        # supply_demand_analysis_task,
        # ...
    ]
)
